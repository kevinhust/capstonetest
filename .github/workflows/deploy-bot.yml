name: Deploy Discord Bot to Cloud Run

on:
  push:
    branches: [main]
    paths:
      - health_butler/**
      - src/**
      - requirements_deploy.txt
      - Dockerfile
      - .github/workflows/deploy-bot.yml
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  SERVICE_NAME: health-butler-discord-bot
  IMAGE_NAME: health-butler-bot
  REGISTRY: us-central1-docker.pkg.dev

jobs:
  qa:
    name: "Quality Assurance & Security"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Lint with ruff
        run: |
          pip install ruff
          ruff check .

      - name: Install minimal test dependencies
        run: |
          pip install pytest pydantic python-dotenv sqlalchemy
          # Installing core swarm logic without full torch/transformers for speed
          pip install -e . || echo "Skipping editable install, using direct path"

      - name: Run Core Logic Tests
        run: |
          # Only run non-heavy tests to keep CI fast
          pytest tests/test_health_swarm.py

  deploy:
    name: "Build & Deploy to Cloud Run"
    needs: [qa]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup gcloud CLI
      uses: google-github-actions/auth@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker to use gcloud credential
      run: gcloud auth configure-docker --quiet

    - name: Build and push Docker image
      run: |
        IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)
        IMAGE_FULL=${REGISTRY}/${PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG}
        IMAGE_LATEST=${REGISTRY}/${PROJECT_ID}/${IMAGE_NAME}:latest
        echo "Building Docker image..."
        docker build -f Dockerfile -t $IMAGE_FULL -t $IMAGE_LATEST .
        echo "Pushing Docker image..."
        docker push $IMAGE_FULL
        docker push $IMAGE_LATEST

    - name: Deploy to Cloud Run
      run: |
        IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)
        IMAGE_FULL=${REGISTRY}/${PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG}
        echo "Deploying to Cloud Run..."
        gcloud run deploy ${SERVICE_NAME} \
          --image=$IMAGE_FULL \
          --platform=managed \
          --region=${REGION} \
          --memory=4Gi \
          --cpu=2 \
          --no-cpu-throttling \
          --min-instances=1 \
          --max-instances=10 \
          --timeout=3600s \
          --concurrency=10 \
          --set-secrets=DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}:latest \
          --set-env-vars="DISCORD_ACTIVITY=Helping_with_nutrition_and_fitness,OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }},OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }},OPENAI_MODEL=${{ secrets.OPENAI_MODEL }},USDA_API_KEY=${{ secrets.USDA_API_KEY }},GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" \
          --allow-unauthenticated \
          --ingress=all \
          --quiet

    - name: Get Service URL
      id: service-url
      run: |
        SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} --region=${REGION} --format=\"value(status.url)\")
        echo \"SERVICE_URL=$SERVICE_URL\" >> $GITHUB_OUTPUT

    - name: Verify deployment
      run: |
        echo \"Waiting for service to be ready...\"
        sleep 30
        HEALTH_URL=${{ steps.service-url.outputs.SERVICE_URL }}/health
        echo \"Checking health at: $HEALTH_URL\"
        for i in $(seq 1 10); do
          if curl -sf $HEALTH_URL > /dev/null; then
            echo \"Health check passed\!\"
            exit 0
          fi
          echo \"Attempt $i/10 failed, retrying in 10s...\"
          sleep 10
        done
        echo \"Health check failed after 10 attempts\"
        exit 1

    - name: Deployment summary
      run: |
        echo \"Deployment Complete\!\" >> $GITHUB_STEP_SUMMARY
        echo \"Service: ${SERVICE_NAME}\" >> $GITHUB_STEP_SUMMARY
        echo \"Region: ${REGION}\" >> $GITHUB_STEP_SUMMARY
        echo \"URL: ${{ steps.service-url.outputs.SERVICE_URL }}\" >> $GITHUB_STEP_SUMMARY
        echo \"Memory: 4Gi, CPU: 2 (Always allocated)\" >> $GITHUB_STEP_SUMMARY

